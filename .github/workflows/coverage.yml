name: Update Coverage Report

on:
  push:
    branches: [main]
    paths:
      - "**.go"
  pull_request:
    branches: [main]
    paths:
      - "**.go"
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for coverage trends

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Generate Coverage Report
        run: make coverage

      # we don't want to fail the build if the coverage is below 80% just yet
      # - name: Check Coverage Thresholds
      #   run: |
      #     TOTAL_COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
      #     if (( $(echo "$TOTAL_COVERAGE < 80" | bc -l) )); then
      #       echo "Coverage is below threshold: $TOTAL_COVERAGE%"
      #       exit 1
      #     fi

      - name: Commit Coverage Report
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git add coverage.md coverage_history.md
          git commit -m "ðŸ“ Update coverage report [skip ci]" || exit 0
          git push

      - name: Create PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const coverage = fs.readFileSync('coverage.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Coverage Report\n\n${coverage}`
            });
